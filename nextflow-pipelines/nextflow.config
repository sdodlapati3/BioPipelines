/*
 * BioPipelines - Nextflow Configuration
 * ======================================
 * Main configuration for multi-user, concurrent pipeline execution
 */

// Enable DSL2
nextflow.enable.dsl = 2

// Global parameters
params {
    // Base directories
    outdir = '/scratch/sdodl001/BioPipelines/data/results'
    
    // Enable trace and timeline
    tracedir = "${params.outdir}/pipeline_info"
}

// Execution configuration
executor {
    name = 'slurm'
    queueSize = 100
    submitRateLimit = '10 sec'
}

// SLURM configuration
process {
    executor = 'slurm'
    queue = 'cpuspot'
    clusterOptions = ''
}

// Work directory - shared across all workflows
// Session management prevents conflicts (see submit script)
workDir = '/scratch/sdodl001/BioPipelines/work'

// Singularity configuration
singularity {
    enabled = true
    autoMounts = true
    cacheDir = '/scratch/sdodl001/BioPipelines/containers/cache'
    runOptions = '--bind /scratch:/scratch'
}

// Session configuration - CRITICAL for concurrent execution
// Use unique session IDs to prevent lock conflicts
dag {
    enabled = false
}

// Timeline and trace
timeline {
    enabled = true
    file = "${params.tracedir}/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.tracedir}/trace.txt"
    overwrite = true
}

report {
    enabled = true
    file = "${params.tracedir}/report.html"
    overwrite = true
}

// Resource management
executor {
    $slurm {
        queueSize = 100
        pollInterval = '15 sec'
        submitRateLimit = '10 sec'
        exitReadTimeout = '15 min'
    }
}

// Profiles for different execution modes
profiles {
    standard {
        process.executor = 'slurm'
    }
    
    test {
        params.outdir = '/scratch/sdodl001/BioPipelines/data/test_results'
    }
    
    debug {
        process.errorStrategy = 'ignore'
        cleanup = false
    }
}

// Manifest
manifest {
    name = 'BioPipelines'
    author = 'BioPipelines Team'
    homePage = 'https://github.com/sdodlapa/BioPipelines'
    description = 'Comprehensive bioinformatics pipelines with Nextflow'
    mainScript = 'main.nf'
    version = '1.0.0'
    nextflowVersion = '>=23.10.0'
}

// Load additional configs
includeConfig 'config/base.config'
includeConfig 'config/containers.config'
