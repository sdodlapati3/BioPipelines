"""
ChIP-seq Peak Calling and Analysis Pipeline
==========================================

Workflow steps:
1. Quality Control (FastQC)
2. Read Trimming (fastp  
3. Alignment (BWA or Bowtie2)
4. Remove Duplicates (Picard)
5. Peak Calling (MACS2)
6. Motif Analysis (HOMER)
7. Signal Tracks (deepTools)
8. MultiQC Report

Usage:
    snakemake --cores 8 --use-conda
"""

# Load configuration
configfile: "config.yaml"

import os
from pathlib import Path

# Get samples
SAMPLES = config["samples"]
INPUT = config["input_control"]
ALL_SAMPLES = SAMPLES + [INPUT]

# Paths
REFERENCE = config["reference"]["genome"]
BLACKLIST = config["reference"].get("blacklist", None)

DATA_BASE = "/scratch/sdodl001/BioPipelines/data"
QC_DIR = f"{DATA_BASE}/results/chip_seq/qc"
PROCESSED_DIR = f"{DATA_BASE}/processed/chip_seq"
RESULTS_DIR = f"{DATA_BASE}/results/chip_seq"
RAW_DIR = f"{DATA_BASE}/raw/chip_seq"

# Auto-detect paired-end vs single-end for each sample
def is_paired_end(sample):
    """Check if sample has paired-end data (_R1 and _R2 files)"""
    r1 = Path(f"{RAW_DIR}/{sample}_R1.fastq.gz")
    r2 = Path(f"{RAW_DIR}/{sample}_R2.fastq.gz")
    se = Path(f"{RAW_DIR}/{sample}.fastq.gz")
    
    if r1.exists() and r2.exists():
        return True
    elif se.exists():
        return False
    else:
        # Default to checking for paired-end pattern
        return r1.exists()

# Determine layout for each sample
SAMPLE_LAYOUT = {sample: "PE" if is_paired_end(sample) else "SE" for sample in ALL_SAMPLES}

# Final outputs
rule all:
    input:
        # Peak files
        expand(f"{RESULTS_DIR}/peaks/{{sample}}_peaks.narrowPeak", sample=SAMPLES),
        # Motif analysis - disabled for small test datasets
        # expand(f"{RESULTS_DIR}/motifs/{{sample}}/homerResults.html", sample=SAMPLES),
        # Signal tracks
        expand(f"{RESULTS_DIR}/bigwig/{{sample}}.bw", sample=SAMPLES),
        # MultiQC
        f"{RESULTS_DIR}/multiqc_report.html"


rule fastqc_raw:
    input:
        lambda w: [f"{RAW_DIR}/{w.sample}_R1.fastq.gz", f"{RAW_DIR}/{w.sample}_R2.fastq.gz"]
                  if SAMPLE_LAYOUT[w.sample] == "PE"
                  else [f"{RAW_DIR}/{w.sample}.fastq.gz"]
    output:
        done=f"{QC_DIR}/fastqc_raw/{{sample}}.done"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    threads: 2
    log:
        f"{QC_DIR}/logs/fastqc_raw/{{sample}}.log"
    params:
        outdir=f"{QC_DIR}/fastqc_raw"
    shell:
        """
        mkdir -p {params.outdir}
        fastqc -t {threads} {input} -o {params.outdir}/ 2> {log}
        touch {output.done}
        """
rule trim_reads:
    input:
        lambda w: [f"{RAW_DIR}/{w.sample}_R1.fastq.gz", f"{RAW_DIR}/{w.sample}_R2.fastq.gz"]
                  if SAMPLE_LAYOUT[w.sample] == "PE"
                  else [f"{RAW_DIR}/{w.sample}.fastq.gz"]
    output:
        html=f"{QC_DIR}/fastp/{{sample}}.html",
        json=f"{QC_DIR}/fastp/{{sample}}.json",
        trimmed=f"{PROCESSED_DIR}/{{sample}}.trimmed.fastq.gz"
    params:
        out_files=lambda w: f"-o {PROCESSED_DIR}/{w.sample}_R1.trimmed.fastq.gz -O {PROCESSED_DIR}/{w.sample}_R2.trimmed.fastq.gz"
                           if SAMPLE_LAYOUT[w.sample] == "PE"
                           else f"-o {PROCESSED_DIR}/{w.sample}.trimmed.fastq.gz",
        in_files=lambda w, input: f"-i {input[0]} -I {input[1]}" if SAMPLE_LAYOUT[w.sample] == "PE" else f"-i {input[0]}"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    threads: 4
    log:
        f"{QC_DIR}/logs/trim/{{sample}}.log"
    shell:
        """
        fastp {params.in_files} {params.out_files} \\
              --thread {threads} \\
              --html {output.html} \\
              --json {output.json} \\
              --cut_right \\
              --cut_right_window_size 4 \\
              --cut_right_mean_quality {config[trimming][quality_cutoff]} \\
              --length_required {config[trimming][min_length]} \\
              2> {log}
        """


rule align_reads:
    input:
        trimmed=f"{PROCESSED_DIR}/{{sample}}.trimmed.fastq.gz",
        ref=REFERENCE
    output:
        bam=temp(f"{PROCESSED_DIR}/{{sample}}.sorted.bam"),
        bai=temp(f"{PROCESSED_DIR}/{{sample}}.sorted.bam.bai")
    params:
        read_files=lambda w: f"{PROCESSED_DIR}/{w.sample}_R1.trimmed.fastq.gz {PROCESSED_DIR}/{w.sample}_R2.trimmed.fastq.gz"
                            if SAMPLE_LAYOUT[w.sample] == "PE"
                            else f"{PROCESSED_DIR}/{w.sample}.trimmed.fastq.gz"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    threads: 8
    log:
        f"{QC_DIR}/logs/align/{{sample}}.log"
    shell:
        """
        bwa mem -t {threads} {input.ref} {params.read_files} 2> {log} | \\
        samtools sort -@ {threads} -o {output.bam} - 2>> {log}
        samtools index {output.bam}
        """


rule mark_duplicates:
    input:
        f"{PROCESSED_DIR}/{{sample}}.sorted.bam"
    output:
        bam=f"{PROCESSED_DIR}/{{sample}}.dedup.bam",
        metrics=f"{QC_DIR}/picard/{{sample}}.dedup_metrics.txt"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    log:
        f"{QC_DIR}/logs/dedup/{{sample}}.log"
    shell:
        """
        gatk MarkDuplicates \\
            -I {input} \\
            -O {output.bam} \\
            -M {output.metrics} \\
            --REMOVE_DUPLICATES true \\
            --CREATE_INDEX true \\
            2> {log}
        """


rule call_peaks:
    input:
        treatment=f"{PROCESSED_DIR}/{{sample}}.dedup.bam",
        control=f"{PROCESSED_DIR}/{INPUT}.dedup.bam"
    output:
        peaks=f"{RESULTS_DIR}/peaks/{{sample}}_peaks.narrowPeak",
        summits=f"{RESULTS_DIR}/peaks/{{sample}}_summits.bed"
    params:
        name="{sample}",
        outdir=f"{RESULTS_DIR}/peaks",
        qvalue=config["peak_calling"]["q_value"],
        gsize=config["peak_calling"]["genome_size"],
        broad="" if not config["peak_calling"]["broad_peaks"] else "--broad"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    log:
        f"{QC_DIR}/logs/peaks/{{sample}}.log"
    shell:
        """
        macs2 callpeak \\
            -t {input.treatment} \\
            -c {input.control} \\
            -f BAM \\
            -g {params.gsize} \\
            -n {params.name} \\
            --outdir {params.outdir} \\
            -q {params.qvalue} \\
            --nomodel \\
            --extsize 147 \\
            {params.broad} \\
            2> {log}
        """


rule homer_motifs:
    input:
        peaks=f"{RESULTS_DIR}/peaks/{{sample}}_peaks.narrowPeak",
        genome=REFERENCE
    output:
        f"{RESULTS_DIR}/motifs/{{sample}}/homerResults.html"
    params:
        outdir=f"{RESULTS_DIR}/motifs/{{sample}}",
        size=config["motif_analysis"]["size"],
        length=config["motif_analysis"]["length"]
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    threads: 8
    log:
        f"{QC_DIR}/logs/motifs/{{sample}}.log"
    shell:
        """
        findMotifsGenome.pl \\
            {input.peaks} \\
            {input.genome} \\
            {params.outdir} \\
            -size {params.size} \\
            -len {params.length} \\
            -p {threads} \\
            2> {log}
        """


rule create_bigwig:
    input:
        f"{PROCESSED_DIR}/{{sample}}.dedup.bam"
    output:
        f"{RESULTS_DIR}/bigwig/{{sample}}.bw"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    threads: 4
    log:
        f"{QC_DIR}/logs/bigwig/{{sample}}.log"
    shell:
        """
        bamCoverage -b {input} -o {output} \\
            -p {threads} \\
            --binSize 10 \\
            --normalizeUsing RPKM \\
            2> {log}
        """


rule multiqc:
    input:
        fastqc=expand(f"{QC_DIR}/fastqc_raw/{{sample}}.done", sample=ALL_SAMPLES),
        fastp=expand(f"{QC_DIR}/fastp/{{sample}}.json", sample=ALL_SAMPLES),
        dedup=expand(f"{QC_DIR}/picard/{{sample}}.dedup_metrics.txt", sample=ALL_SAMPLES)
    output:
        f"{RESULTS_DIR}/multiqc_report.html"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/chip-seq_1.0.0.sif"
    log:
        f"{QC_DIR}/logs/multiqc.log"
    shell:
        """
        multiqc {QC_DIR} -o {RESULTS_DIR} -f 2> {log}
        """
