# Single-Cell RNA-seq Analysis Pipeline
# ======================================
# 10x Genomics Chromium data processing with CellRanger and Seurat

configfile: "config.yaml"

import os

# Samples
SAMPLES = list(config["samples"].keys())
PROCESSED_DIR = config["processed_dir"]
RESULTS_DIR = config["results_dir"]
REFERENCE = config["reference"]["genome"]

# Create output directories
os.makedirs(PROCESSED_DIR, exist_ok=True)
os.makedirs(RESULTS_DIR, exist_ok=True)
os.makedirs(f"{RESULTS_DIR}/qc", exist_ok=True)
os.makedirs(f"{RESULTS_DIR}/clustering", exist_ok=True)
os.makedirs(f"{RESULTS_DIR}/markers", exist_ok=True)
os.makedirs(f"{RESULTS_DIR}/plots", exist_ok=True)

# Target rule
rule all:
    input:
        # CellRanger outputs
        expand(f"{PROCESSED_DIR}/{{sample}}/outs/web_summary.html", sample=SAMPLES),
        expand(f"{PROCESSED_DIR}/{{sample}}/outs/filtered_feature_bc_matrix.h5", sample=SAMPLES),
        
        # Seurat outputs
        expand(f"{RESULTS_DIR}/{{sample}}_seurat.rds", sample=SAMPLES),
        expand(f"{RESULTS_DIR}/qc/{{sample}}_qc_metrics.txt", sample=SAMPLES),
        expand(f"{RESULTS_DIR}/clustering/{{sample}}_clusters.csv", sample=SAMPLES),
        expand(f"{RESULTS_DIR}/markers/{{sample}}_markers.csv", sample=SAMPLES),
        
        # Plots
        expand(f"{RESULTS_DIR}/plots/{{sample}}_umap.png", sample=SAMPLES),
        expand(f"{RESULTS_DIR}/plots/{{sample}}_qc_violin.png", sample=SAMPLES)

# Rule 1: Run CellRanger count
rule cellranger_count:
    input:
        fastqs = lambda wildcards: config["samples"][wildcards.sample]["fastqs"]
    output:
        web_summary = f"{PROCESSED_DIR}/{{sample}}/outs/web_summary.html",
        matrix = f"{PROCESSED_DIR}/{{sample}}/outs/filtered_feature_bc_matrix.h5",
        bam = f"{PROCESSED_DIR}/{{sample}}/outs/possorted_genome_bam.bam",
        metrics = f"{PROCESSED_DIR}/{{sample}}/outs/metrics_summary.csv"
    params:
        sample_name = lambda wildcards: config["samples"][wildcards.sample]["sample_name"],
        outdir = PROCESSED_DIR,
        reference = REFERENCE,
        chemistry = config["cellranger"]["chemistry"],
        expect_cells = config["cellranger"]["expect_cells"],
        force_cells = config["cellranger"].get("force_cells", ""),
        include_introns = "--include-introns" if config["cellranger"]["include_introns"] else ""
    threads: config["resources"]["cellranger_threads"]
    resources:
        mem_mb = lambda wildcards, attempt: int(config["resources"]["cellranger_mem"].replace("G", "")) * 1024 * attempt
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    log:
        f"{RESULTS_DIR}/logs/cellranger/{{sample}}.log"
    shell:
        """
        cd {params.outdir}
        
        # Remove existing output directory if it exists (CellRanger 10.0.0 requirement)
        if [ -d "{wildcards.sample}" ]; then
            rm -rf {wildcards.sample}
        fi
        
        # CellRanger count
        cellranger count \
            --id={wildcards.sample} \
            --transcriptome={params.reference} \
            --fastqs={input.fastqs} \
            --sample={params.sample_name} \
            --chemistry={params.chemistry} \
            --expect-cells={params.expect_cells} \
            --create-bam=true \
            {params.include_introns} \
            --localcores={threads} \
            --localmem={resources.mem_mb} \
            2>&1 | tee {log}
        """

# Rule 2: QC and filtering with Seurat
rule seurat_qc:
    input:
        matrix = f"{PROCESSED_DIR}/{{sample}}/outs/filtered_feature_bc_matrix.h5"
    output:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat_qc.rds",
        metrics = f"{RESULTS_DIR}/qc/{{sample}}_qc_metrics.txt",
        violin = f"{RESULTS_DIR}/plots/{{sample}}_qc_violin.png"
    params:
        min_genes = config["seurat"]["qc"]["min_genes"],
        max_genes = config["seurat"]["qc"]["max_genes"],
        max_mt = config["seurat"]["qc"]["max_mt_percent"],
        sample_name = "{sample}"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    threads: config["resources"]["seurat_threads"]
    log:
        f"{RESULTS_DIR}/logs/seurat/{{sample}}_qc.log"
    script:
        "scripts/seurat_qc.R"

# Rule 3: Normalization and variable features
rule seurat_normalize:
    input:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat_qc.rds"
    output:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat_norm.rds"
    params:
        method = config["seurat"]["normalization"]["method"],
        scale_factor = config["seurat"]["normalization"]["scale_factor"],
        n_features = config["seurat"]["variable_features"]["n_features"]
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    log:
        f"{RESULTS_DIR}/logs/seurat/{{sample}}_normalize.log"
    script:
        "scripts/seurat_normalize.R"

# Rule 4: PCA and clustering
rule seurat_cluster:
    input:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat_norm.rds"
    output:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat.rds",
        clusters = f"{RESULTS_DIR}/clustering/{{sample}}_clusters.csv",
        pca_plot = f"{RESULTS_DIR}/plots/{{sample}}_pca.png",
        umap_plot = f"{RESULTS_DIR}/plots/{{sample}}_umap.png"
    params:
        n_pcs = config["seurat"]["pca"]["n_pcs"],
        dims = config["seurat"]["clustering"]["dims"],
        resolution = config["seurat"]["clustering"]["resolution"],
        algorithm = config["seurat"]["clustering"]["algorithm"]
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    threads: config["resources"]["seurat_threads"]
    log:
        f"{RESULTS_DIR}/logs/seurat/{{sample}}_cluster.log"
    script:
        "scripts/seurat_cluster.R"

# Rule 5: Find marker genes
rule seurat_markers:
    input:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat.rds"
    output:
        markers = f"{RESULTS_DIR}/markers/{{sample}}_markers.csv",
        heatmap = f"{RESULTS_DIR}/plots/{{sample}}_markers_heatmap.png",
        dotplot = f"{RESULTS_DIR}/plots/{{sample}}_markers_dotplot.png"
    params:
        test = config["seurat"]["de"]["test"],
        logfc_threshold = config["seurat"]["de"]["logfc_threshold"],
        min_pct = config["seurat"]["de"]["min_pct"],
        only_pos = config["seurat"]["de"]["only_pos"]
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    log:
        f"{RESULTS_DIR}/logs/seurat/{{sample}}_markers.log"
    script:
        "scripts/seurat_markers.R"

# Rule 6: Cell type annotation
rule annotate_cells:
    input:
        seurat = f"{RESULTS_DIR}/{{sample}}_seurat.rds",
        markers = f"{RESULTS_DIR}/markers/{{sample}}_markers.csv"
    output:
        annotated = f"{RESULTS_DIR}/{{sample}}_annotated.rds",
        umap = f"{RESULTS_DIR}/plots/{{sample}}_umap_annotated.png",
        composition = f"{RESULTS_DIR}/{{sample}}_cell_composition.txt"
    params:
        marker_genes = config["annotation"]["markers"]
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    log:
        f"{RESULTS_DIR}/logs/seurat/{{sample}}_annotate.log"
    script:
        "scripts/annotate_cells.R"

# Rule 7: Generate summary report
rule generate_report:
    input:
        cellranger_summary = expand(f"{PROCESSED_DIR}/{{sample}}/outs/web_summary.html", sample=SAMPLES),
        qc_metrics = expand(f"{RESULTS_DIR}/qc/{{sample}}_qc_metrics.txt", sample=SAMPLES),
        clusters = expand(f"{RESULTS_DIR}/clustering/{{sample}}_clusters.csv", sample=SAMPLES),
        markers = expand(f"{RESULTS_DIR}/markers/{{sample}}_markers.csv", sample=SAMPLES)
    output:
        report = f"{RESULTS_DIR}/scRNA_seq_analysis_report.html"
    container: "/home/sdodl001_odu_edu/BioPipelines/containers/images/scrna-seq_1.0.0.sif"
    log:
        f"{RESULTS_DIR}/logs/report.log"
    script:
        "scripts/generate_report.Rmd"
