%%{init: {'theme': 'base'}}%%

graph TB
    subgraph TOOLS_32["ğŸ”§ 32 Agent Tools"]
        direction TB
        
        subgraph CAT_DATA["ğŸ“Š Data Discovery (6)"]
            T1["scan_data<br/>ğŸ” Scan directories"]
            T2["search_databases<br/>ğŸ—ƒï¸ Query GEO/ENCODE/SRA"]
            T3["search_tcga<br/>ğŸ¥ TCGA cancer data"]
            T4["describe_files<br/>ğŸ“‹ File metadata"]
            T5["validate_dataset<br/>âœ… Data validation"]
            T6["check_references<br/>ğŸ§¬ Reference status"]
        end

        subgraph CAT_MGMT["ğŸ“ Data Management (4)"]
            T7["download_dataset<br/>â¬‡ï¸ Fetch from source"]
            T8["download_reference<br/>ğŸ§¬ Get reference genome"]
            T9["build_index<br/>ğŸ”¨ Create alignments index"]
            T10["cleanup_data<br/>ğŸ—‘ï¸ Remove old data"]
        end

        subgraph CAT_WF["ğŸ“‹ Workflow (5)"]
            T11["generate_workflow<br/>âš™ï¸ Create pipeline"]
            T12["list_workflows<br/>ğŸ“œ Show available"]
            T13["visualize_workflow<br/>ğŸ“Š DAG visualization"]
            T14["analyze_results<br/>ğŸ“ˆ Interpret outputs"]
            T15["compare_samples<br/>ğŸ”„ Sample comparison"]
        end

        subgraph CAT_EXEC["âš¡ Execution (8)"]
            T16["submit_job<br/>ğŸš€ Submit to SLURM"]
            T17["get_job_status<br/>ğŸ“Š Check status"]
            T18["get_logs<br/>ğŸ“ View logs"]
            T19["cancel_job<br/>ğŸ›‘ Stop job"]
            T20["resubmit_job<br/>ğŸ”„ Retry failed"]
            T21["watch_job<br/>ğŸ‘ï¸ Live monitoring"]
            T22["list_jobs<br/>ğŸ“‹ All jobs"]
            T23["monitor_jobs<br/>ğŸ“º Dashboard"]
        end

        subgraph CAT_DIAG["ğŸ” Diagnostics (5)"]
            T24["diagnose_error<br/>ğŸ”¬ Analyze failure"]
            T25["recover_error<br/>ğŸ”§ Auto-fix"]
            T26["check_system_health<br/>ğŸ’š System status"]
            T27["restart_vllm<br/>ğŸ”„ Restart LLM"]
            T28["download_results<br/>ğŸ“¦ Get outputs"]
        end

        subgraph CAT_EDU["ğŸ“š Education (4)"]
            T29["explain_concept<br/>ğŸ’¡ Explain terms"]
            T30["show_help<br/>â“ Show commands"]
            T31["run_command<br/>âŒ¨ï¸ Safe shell"]
            T32["confirm_cleanup<br/>âœ… Confirm delete"]
        end
    end

    subgraph PERMISSIONS["ğŸ”’ Permission Categories"]
        P_READ["ğŸ“– READ<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Always allowed<br/>No side effects"]
        P_WRITE["ğŸ“ WRITE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ASSISTED+ level<br/>Creates files"]
        P_EXEC["âš¡ EXECUTE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SUPERVISED+ level<br/>Runs processes"]
        P_DEL["ğŸ—‘ï¸ DELETE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Always approval<br/>Destructive"]
    end

    %% Permission mappings
    T1 & T2 & T3 & T4 & T5 & T6 --> P_READ
    T12 & T13 & T14 & T15 --> P_READ
    T17 & T18 & T21 & T22 & T23 --> P_READ
    T24 & T26 --> P_READ
    T29 & T30 --> P_READ

    T7 & T8 --> P_WRITE
    T11 --> P_WRITE
    T28 --> P_WRITE

    T9 --> P_EXEC
    T16 & T19 & T20 --> P_EXEC
    T25 & T27 --> P_EXEC
    T31 --> P_EXEC

    T10 & T32 --> P_DEL

    subgraph REGISTRY["ğŸ“‹ ToolRegistry"]
        REG["@ToolRegistry.register()<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ name<br/>â€¢ description<br/>â€¢ parameters<br/>â€¢ patterns<br/>â€¢ category"]
        
        OPENAI["to_openai_format()<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>OpenAI function<br/>calling format"]
        
        DETECT["detect_tool(message)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Pattern matching<br/>Tool selection"]
    end

    CAT_DATA & CAT_MGMT & CAT_WF & CAT_EXEC & CAT_DIAG & CAT_EDU --> REG
    REG --> OPENAI
    REG --> DETECT

    %% Styling
    classDef read fill:#c8e6c9,stroke:#2e7d32
    classDef write fill:#fff3e0,stroke:#f57c00
    classDef execute fill:#e3f2fd,stroke:#1976d2
    classDef delete fill:#ffcdd2,stroke:#c62828

    class P_READ,T1,T2,T3,T4,T5,T6,T12,T13,T14,T15,T17,T18,T21,T22,T23,T24,T26,T29,T30 read
    class P_WRITE,T7,T8,T11,T28 write
    class P_EXEC,T9,T16,T19,T20,T25,T27,T31 execute
    class P_DEL,T10,T32 delete
