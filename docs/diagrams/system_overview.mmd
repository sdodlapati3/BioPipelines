%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'secondaryColor': '#f4f4f4', 'tertiaryColor': '#fff', 'primaryTextColor': '#333', 'lineColor': '#666'}}}%%

flowchart TB
    subgraph USER["ğŸ‘¤ User Interface Layer"]
        CLI["ğŸ–¥ï¸ CLI<br/>cli.py"]
        WEB["ğŸŒ Web Interface<br/>web/app.py"]
        API["ğŸ“¡ Programmatic API"]
    end

    subgraph ORCHESTRATION["ğŸ¤– Orchestration Layer"]
        UA["ğŸ¯ UnifiedAgent<br/>unified_agent.py<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Task Classification<br/>â€¢ Permission Control<br/>â€¢ Tool Dispatch<br/>â€¢ Response Building"]
        
        COMPOSER["ğŸ“‹ Composer<br/>composer.py<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Query Parsing<br/>â€¢ Tool Selection<br/>â€¢ Workflow Generation"]
    end

    subgraph CAPABILITIES["âš¡ Capability Layers"]
        direction TB
        
        subgraph TOOLS["ğŸ”§ Tools (32 total)"]
            T_DATA["ğŸ“Š Data Discovery<br/>6 tools"]
            T_MGMT["ğŸ“ Data Management<br/>4 tools"]
            T_WF["ğŸ“‹ Workflow<br/>5 tools"]
            T_EXEC["âš¡ Execution<br/>8 tools"]
            T_DIAG["ğŸ” Diagnostics<br/>5 tools"]
            T_EDU["ğŸ“š Education<br/>4 tools"]
        end

        subgraph AUTONOMOUS["ğŸ”„ Autonomous System"]
            AUTO_AGENT["AutonomousAgent"]
            HEALTH["HealthChecker"]
            JOB_MON["JobMonitor"]
            RECOVERY["RecoveryManager"]
        end

        subgraph EXECUTOR["ğŸ›¡ï¸ Executor Layer"]
            PERM["PermissionManager<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>5 Autonomy Levels"]
            SANDBOX["CommandSandbox<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Safe Execution"]
            AUDIT["AuditLogger<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Complete Trail"]
            FILE_OPS["FileOperations"]
            PROC_MGR["ProcessManager"]
        end
    end

    subgraph SERVICES["ğŸ“š Core Services"]
        direction TB
        
        subgraph CORE["Core Processing"]
            QP["QueryParser"]
            TS["ToolSelector"]
            MM["ModuleMapper"]
            WG["WorkflowGenerator"]
        end

        subgraph PROVIDERS["ğŸ§  LLM Providers (6)"]
            P_OPENAI["OpenAI"]
            P_ANTHROPIC["Anthropic"]
            P_GEMINI["Gemini"]
            P_OLLAMA["Ollama"]
            P_VLLM["vLLM"]
            P_LIGHTNING["Lightning"]
        end

        subgraph DATA["ğŸ—„ï¸ Data Layer"]
            DISCOVERY["DataDiscovery"]
            DOWNLOAD["Downloader"]
            REF_MGR["ReferenceManager"]
            SCANNER["Scanner"]
        end
    end

    subgraph INFRASTRUCTURE["ğŸ—ï¸ Infrastructure"]
        SLURM["SLURM HPC"]
        CONTAINERS["Containers<br/>12 categories"]
        STORAGE["Storage<br/>Local/Cloud"]
    end

    %% Connections - User to Orchestration
    CLI --> UA
    WEB --> UA
    API --> UA
    CLI --> COMPOSER
    
    %% Orchestration internal
    UA <--> COMPOSER
    
    %% Orchestration to Capabilities
    UA --> TOOLS
    UA --> EXECUTOR
    UA --> AUTONOMOUS
    
    %% Capabilities internal
    TOOLS --> EXECUTOR
    AUTONOMOUS --> EXECUTOR
    AUTONOMOUS --> TOOLS
    
    %% Executor internal
    PERM --> SANDBOX
    SANDBOX --> AUDIT
    SANDBOX --> FILE_OPS
    SANDBOX --> PROC_MGR
    
    %% Capabilities to Services
    TOOLS --> CORE
    TOOLS --> DATA
    COMPOSER --> CORE
    CORE --> PROVIDERS
    
    %% Autonomous internal
    AUTO_AGENT --> HEALTH
    AUTO_AGENT --> JOB_MON
    AUTO_AGENT --> RECOVERY
    
    %% Services to Infrastructure
    CORE --> INFRASTRUCTURE
    DATA --> STORAGE
    EXECUTOR --> SLURM
    EXECUTOR --> CONTAINERS

    %% Styling
    classDef userLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef orchestration fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef capabilities fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef services fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef infra fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px

    class CLI,WEB,API userLayer
    class UA,COMPOSER orchestration
    class TOOLS,AUTONOMOUS,EXECUTOR capabilities
    class CORE,PROVIDERS,DATA services
    class SLURM,CONTAINERS,STORAGE infra
