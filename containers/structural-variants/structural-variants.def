Bootstrap: localimage
From: /scratch/sdodl001/containers/base_1.0.0.sif

%labels
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team"
    org.opencontainers.image.title="BioPipelines Structural Variants Container"
    org.opencontainers.image.description="Structural variant calling with Manta, LUMPY, Delly, and SV annotation tools"
    pipeline.name="structural-variants"
    pipeline.version="1.0.0"

%files
    entrypoint.sh /opt/biopipelines/entrypoint.sh
    run_pipeline.sh /opt/biopipelines/run_pipeline.sh

%post
    # Install structural variant specific tools (common tools now in base)
    # Note: manta, lumpy-sv, smoove, pbsv require Python 2.7 - not compatible with Python 3.11 base
    # Using Python 3 compatible SV callers:
    #   - delly: deletion, duplication, inversion, translocation detection
    #   - svim: long-read SV detection
    #   - sniffles: long-read SV detection (PacBio/Nanopore)
    #   - cutesv: accurate long-read SV detection
    #   - dysgu: short/long-read SV detection (alternative to manta/lumpy)
    #   - survivor: SV merging and comparison
    micromamba install -y -n base -c conda-forge -c bioconda \
        delly \
        svim \
        sniffles \
        cutesv \
        dysgu \
        minimap2 \
        survivor \
        vcftools

    # Make scripts executable
    chmod +x /opt/biopipelines/entrypoint.sh /opt/biopipelines/run_pipeline.sh
    
    # Create pipeline directory
    mkdir -p /opt/biopipelines/structural_variants

    # Clean up
    micromamba clean --all --yes

%environment
    export PIPELINE_NAME="structural-variants"
    export PIPELINE_VERSION="1.0.0"

%runscript
    exec /opt/biopipelines/entrypoint.sh "$@"

%test
    # Test SV tools (Python 3 compatible)
    delly version 2>&1 | head -1 || true
    sniffles --version
    dysgu --version 2>&1 | head -1 || true
    echo "Structural variants container validation passed"
