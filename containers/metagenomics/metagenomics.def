Bootstrap: localimage
From: /scratch/sdodl001/containers/base_1.0.0.sif

%labels
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team"
    org.opencontainers.image.title="BioPipelines Metagenomics Container"
    org.opencontainers.image.description="Metagenomics analysis with Kraken2, MetaPhlAn, and taxonomic profiling tools"
    pipeline.name="metagenomics"
    pipeline.version="1.0.0"

%files
    entrypoint.sh /opt/biopipelines/entrypoint.sh
    run_pipeline.sh /opt/biopipelines/run_pipeline.sh

%post
    # Install metagenomics specific tools (common tools now in base)
    micromamba install -y -n base -c conda-forge -c bioconda \
        kraken2=2.1.3 \
        bracken=2.9 \
        metaphlan=4.1.1 \
        humann=3.9 \
        megahit=1.2.9 \
        spades \
        prodigal=2.6.3 \
        prokka=1.14.6 \
        diamond=2.1.10 \
        bbmap=39.10 \
        seqtk=1.4 \
        centrifuge=1.0.4.1 \
        krona=2.8.1 \
        r-vegan

    # Make scripts executable
    chmod +x /opt/biopipelines/entrypoint.sh /opt/biopipelines/run_pipeline.sh
    
    # Create pipeline directory
    mkdir -p /opt/biopipelines/metagenomics

    # Clean up
    micromamba clean --all --yes

%environment
    export PIPELINE_NAME="metagenomics"
    export PIPELINE_VERSION="1.0.0"

%runscript
    exec /opt/biopipelines/entrypoint.sh "$@"

%test
    # Test metagenomics tools
    kraken2 --version
    metaphlan --version
    megahit --version
    echo "Metagenomics container validation passed"
