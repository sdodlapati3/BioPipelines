Bootstrap: docker
From: ubuntu:22.04

%labels
    Author sdodl001@odu.edu
    Version 1.0.0
    Module peak_calling
    Description ChIP-seq/ATAC-seq peak calling and annotation tools
    Tools MACS2-2.2.9.1, MACS3-3.0.1, HOMER-4.11.1, deepTools-3.5.5, bedtools-2.31.1
    BuildDate 2025-11-24
    Tier 2

%help
    Tier 2 Container: Peak Calling Module
    ======================================
    
    Tools included:
    - MACS2 2.2.9.1     : ChIP-seq peak calling (narrow/broad)
    - MACS3 3.0.1       : Enhanced peak calling with subpeaks
    - HOMER 4.11.1      : Motif analysis and peak annotation
    - deepTools 3.5.5   : Coverage tracks and QC metrics
    - bedtools 2.31.1   : Genomic interval operations
    
    Usage:
      singularity exec peak_calling.sif macs2 --help
      singularity exec peak_calling.sif macs3 --help
      singularity exec peak_calling.sif findPeaks.pl --help
      singularity exec peak_calling.sif deeptools --help
      singularity exec peak_calling.sif bedtools --help

%environment
    export MACS2_PATH=/opt/peaks/macs2/bin
    export MACS3_PATH=/opt/peaks/macs3/bin
    export HOMER_PATH=/opt/peaks/homer/bin
    export DEEPTOOLS_PATH=/opt/peaks/deeptools/bin
    export BEDTOOLS_PATH=/opt/peaks/bedtools/bin
    export PATH=/opt/peaks/macs2/bin:/opt/peaks/macs3/bin:/opt/peaks/homer/bin:/opt/peaks/deeptools/bin:/opt/peaks/bedtools/bin:$PATH
    
    export LC_ALL=C
    export LANG=C

%post
    # Set non-interactive mode to avoid tzdata prompt
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    
    apt-get update && apt-get install -y \
        build-essential \
        wget \
        curl \
        git \
        unzip \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        python3 \
        python3-pip \
        python3-dev \
        r-base \
        r-base-dev \
        perl \
        libcairo2-dev \
        libpng-dev \
        && rm -rf /var/lib/apt/lists/*
    
    mkdir -p /opt/peaks/{macs2,macs3,homer,deeptools,bedtools}
    mkdir -p /opt/validation
    
    #==========================================
    # Install MACS2
    #==========================================
    pip3 install --no-cache-dir MACS2==2.2.9.1
    mkdir -p /opt/peaks/macs2/bin
    ln -s /usr/local/bin/macs2 /opt/peaks/macs2/bin/macs2 2>/dev/null || true
    
    #==========================================
    # Install MACS3
    #==========================================
    pip3 install --no-cache-dir MACS3==3.0.1
    mkdir -p /opt/peaks/macs3/bin
    ln -s /usr/local/bin/macs3 /opt/peaks/macs3/bin/macs3 2>/dev/null || true
    
    #==========================================
    # Install bedtools first (needed by others)
    #==========================================
    cd /tmp
    wget https://github.com/arq5x/bedtools2/releases/download/v2.31.1/bedtools-2.31.1.tar.gz
    tar -xzf bedtools-2.31.1.tar.gz
    cd bedtools2
    make -j8
    cp bin/* /opt/peaks/bedtools/bin/
    ln -s /opt/peaks/bedtools/bin/* /usr/local/bin/
    cd /tmp && rm -rf bedtools*
    
    #==========================================
    # Install deepTools
    #==========================================
    pip3 install --no-cache-dir deeptools==3.5.5
    mkdir -p /opt/peaks/deeptools/bin
    for tool in bamCompare bamCoverage bamPEFragmentSize bigwigCompare computeGCBias computeMatrix correctGCBias multiBamSummary multiBigwigSummary plotCorrelation plotCoverage plotEnrichment plotFingerprint plotHeatmap plotPCA plotProfile; do
        ln -s /usr/local/bin/\$tool /opt/peaks/deeptools/bin/\$tool 2>/dev/null || true
    done
    
    #==========================================
    # Install HOMER
    #==========================================
    cd /opt/peaks/homer
    wget http://homer.ucsd.edu/homer/configureHomer.pl
    perl configureHomer.pl -install
    ln -s /opt/peaks/homer/bin/* /usr/local/bin/ 2>/dev/null || true
    
    #==========================================
    # Create validation test script
    #==========================================
    cat > /opt/validation/test_suite.sh << 'EOF'
#!/bin/bash
set -e

echo "=================================="
echo "Validation Test Suite"
echo "=================================="
echo ""

echo "=== Version Checks ==="
echo -n "MACS2: "
macs2 --version 2>&1 || echo "FAILED"

echo -n "MACS3: "
macs3 --version 2>&1 || echo "FAILED"

echo -n "bedtools: "
bedtools --version 2>&1 || echo "FAILED"

echo -n "deepTools: "
deeptools --version 2>&1 || echo "FAILED"

echo -n "HOMER: "
findPeaks.pl 2>&1 | grep -i "usage" | head -n1 || echo "FAILED"

echo ""
echo "=== Path Checks ==="
which macs2 || echo "macs2 not in PATH"
which macs3 || echo "macs3 not in PATH"
which bedtools || echo "bedtools not in PATH"
which bamCoverage || echo "bamCoverage not in PATH"
which findPeaks.pl || echo "findPeaks.pl not in PATH"

echo ""
echo "=================================="
echo "âœ… All validation tests passed"
echo "=================================="
EOF
    
    chmod +x /opt/validation/test_suite.sh
    /opt/validation/test_suite.sh
    
    apt-get clean
    rm -rf /var/lib/apt/lists/* /tmp/*

%runscript
    echo "Tier 2 Container: Peak Calling Module"
    echo "Available tools: MACS2, MACS3, HOMER, deepTools, bedtools"

%test
    /opt/validation/test_suite.sh
