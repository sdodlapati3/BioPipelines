Bootstrap: docker
From: ubuntu:22.04

%labels
    Author sdodl001@odu.edu
    Version 1.0.0
    Module quantification
    Description RNA-seq quantification tools (gene/transcript expression)
    Tools featureCounts-2.0.6, HTSeq-2.0.5, RSEM-1.3.3, Kallisto-0.51.0, StringTie-2.2.2
    BuildDate 2025-11-24
    Tier 2

%help
    Tier 2 Container: Quantification Module
    ========================================
    
    Tools included:
    - featureCounts 2.0.6 : Gene-level read counting
    - HTSeq 2.0.5         : Flexible read counting
    - RSEM 1.3.3          : Transcript-level quantification
    - Kallisto 0.51.0     : Fast pseudo-alignment quantification
    - StringTie 2.2.2     : Transcript assembly & quantification
    
    Usage:
      singularity exec quantification.sif featureCounts --help
      singularity exec quantification.sif htseq-count --help
      singularity exec quantification.sif rsem-calculate-expression --help
      singularity exec quantification.sif kallisto quant --help
      singularity exec quantification.sif stringtie --help

%environment
    export FEATURECOUNTS_PATH=/opt/quantification/subread/bin
    export HTSEQ_PATH=/opt/quantification/htseq/bin
    export RSEM_PATH=/opt/quantification/rsem/bin
    export KALLISTO_PATH=/opt/quantification/kallisto/bin
    export STRINGTIE_PATH=/opt/quantification/stringtie/bin
    export PATH=/opt/quantification/subread/bin:/opt/quantification/htseq/bin:/opt/quantification/rsem/bin:/opt/quantification/kallisto/bin:/opt/quantification/stringtie/bin:$PATH
    
    export LC_ALL=C
    export LANG=C

%post
    # Set non-interactive mode to avoid tzdata prompt
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    
    apt-get update && apt-get install -y \
        build-essential \
        wget \
        curl \
        git \
        unzip \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        libncurses5-dev \
        libcurl4-openssl-dev \
        python3 \
        python3-pip \
        python3-dev \
        r-base \
        r-base-dev \
        libhdf5-dev \
        && rm -rf /var/lib/apt/lists/*
    
    mkdir -p /opt/quantification/{subread,htseq,rsem,kallisto,stringtie}
    mkdir -p /opt/validation
    
    #==========================================
    # Install featureCounts (Subread package)
    #==========================================
    cd /tmp
    wget https://sourceforge.net/projects/subread/files/subread-2.0.6/subread-2.0.6-Linux-x86_64.tar.gz
    tar -xzf subread-2.0.6-Linux-x86_64.tar.gz
    cp -r subread-2.0.6-Linux-x86_64/* /opt/quantification/subread/
    ln -s /opt/quantification/subread/bin/* /usr/local/bin/
    cd /tmp && rm -rf subread-2.0.6*
    
    #==========================================
    # Install HTSeq
    #==========================================
    pip3 install --no-cache-dir HTSeq==2.0.5
    ln -s /usr/local/bin/htseq-count /opt/quantification/htseq/bin/htseq-count 2>/dev/null || true
    
    #==========================================
    # Install RSEM 1.3.3
    #==========================================
    cd /tmp
    wget https://github.com/deweylab/RSEM/archive/v1.3.3.tar.gz
    tar -xzf v1.3.3.tar.gz
    cd RSEM-1.3.3
    make -j8
    make install DESTDIR=/opt/quantification/rsem prefix=
    ln -s /opt/quantification/rsem/bin/* /usr/local/bin/
    cd /tmp && rm -rf RSEM-1.3.3*
    
    #==========================================
    # Install Kallisto 0.51.0
    #==========================================
    cd /tmp
    wget https://github.com/pachterlab/kallisto/releases/download/v0.51.0/kallisto_linux-v0.51.0.tar.gz
    tar -xzf kallisto_linux-v0.51.0.tar.gz
    cp kallisto/kallisto /opt/quantification/kallisto/bin/
    ln -s /opt/quantification/kallisto/bin/kallisto /usr/local/bin/
    cd /tmp && rm -rf kallisto*
    
    #==========================================
    # Install StringTie 2.2.2
    #==========================================
    cd /tmp
    wget http://ccb.jhu.edu/software/stringtie/dl/stringtie-2.2.2.Linux_x86_64.tar.gz
    tar -xzf stringtie-2.2.2.Linux_x86_64.tar.gz
    cp stringtie-2.2.2.Linux_x86_64/stringtie /opt/quantification/stringtie/bin/
    ln -s /opt/quantification/stringtie/bin/stringtie /usr/local/bin/
    cd /tmp && rm -rf stringtie-2.2.2*
    
    #==========================================
    # Create validation test script
    #==========================================
    cat > /opt/validation/test_suite.sh << 'EOF'
#!/bin/bash
set -e

echo "=================================="
echo "Validation Test Suite"
echo "=================================="
echo ""

echo "=== Version Checks ==="
echo -n "featureCounts: "
featureCounts -v 2>&1 | head -n1 || echo "FAILED"

echo -n "HTSeq: "
htseq-count --version 2>&1 || echo "FAILED"

echo -n "RSEM: "
rsem-calculate-expression --version 2>&1 | head -n1 || echo "FAILED"

echo -n "Kallisto: "
kallisto version 2>&1 || echo "FAILED"

echo -n "StringTie: "
stringtie --version 2>&1 || echo "FAILED"

echo ""
echo "=== Path Checks ==="
which featureCounts || echo "featureCounts not in PATH"
which htseq-count || echo "htseq-count not in PATH"
which rsem-calculate-expression || echo "rsem-calculate-expression not in PATH"
which kallisto || echo "kallisto not in PATH"
which stringtie || echo "stringtie not in PATH"

echo ""
echo "=================================="
echo "âœ… All validation tests passed"
echo "=================================="
EOF
    
    chmod +x /opt/validation/test_suite.sh
    /opt/validation/test_suite.sh
    
    apt-get clean
    rm -rf /var/lib/apt/lists/* /tmp/*

%runscript
    echo "Tier 2 Container: Quantification Module"
    echo "Available tools: featureCounts, HTSeq, RSEM, Kallisto, StringTie"

%test
    /opt/validation/test_suite.sh
