Bootstrap: docker
From: mambaorg/micromamba:1.5.10

%labels
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team"
    org.opencontainers.image.title="BioPipelines Workflow Engine Container"
    org.opencontainers.image.description="Snakemake and Nextflow orchestration container for BioPipelines"
    container.type="workflow-engine"
    container.version="1.0.0"

%post
    # Install workflow engines and dependencies
    micromamba install -y -n base -c conda-forge -c bioconda \
        snakemake=8.20.5 \
        snakemake-executor-plugin-slurm=0.11.2 \
        nextflow=24.10.0 \
        python=3.11 \
        pandas \
        pyyaml \
        jinja2 \
        cookiecutter \
        graphviz \
        git

    # Clean up
    micromamba clean --all --yes

%environment
    export JAVA_HOME=/opt/conda
    export PATH=/opt/conda/bin:$PATH
    export WORKFLOW_ENGINE_VERSION="1.0.0"
    export NXF_HOME=/tmp/.nextflow

%runscript
    # Default: run snakemake
    exec snakemake "$@"

%apprun snakemake
    exec snakemake "$@"

%apprun nextflow
    exec nextflow "$@"

%test
    echo "Testing workflow engines..."
    snakemake --version
    mkdir -p /tmp/.nextflow
    export NXF_HOME=/tmp/.nextflow
    nextflow -version
    python --version
    echo "Workflow engine container validation passed"
