Bootstrap: localimage
From: /home/sdodl001_odu_edu/BioPipelines/containers/images/base_1.0.0.sif

%labels
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team"
    org.opencontainers.image.title="BioPipelines scRNA-seq Container"
    org.opencontainers.image.description="Single-cell RNA-seq analysis with Seurat, Scanpy, and Cell Ranger"
    pipeline.name="scrna-seq"
    pipeline.version="1.0.0"

%files
    entrypoint.sh /opt/biopipelines/entrypoint.sh
    run_pipeline.sh /opt/biopipelines/run_pipeline.sh

%post
    # Install scRNA-seq specific tools (common tools now in base)
    micromamba install -y -n base -c conda-forge -c bioconda \
        star=2.7.11a \
        salmon=1.10.3 \
        velocyto.py=0.17.17 \
        scrublet=0.2.3 \
        scanpy=1.10.4 \
        anndata=0.10.9 \
        scikit-learn \
        umap-learn \
        leidenalg \
        louvain \
        r-seurat \
        bioconductor-singlecellexperiment \
        bioconductor-scater \
        bioconductor-scran \
        r-cowplot \
        r-patchwork

    # Install Cell Ranger from 10x Genomics
    cd /opt
    wget -O cellranger-9.0.0.tar.gz "https://cf.10xgenomics.com/releases/cell-exp/cellranger-9.0.0.tar.gz?Expires=1732496160&Key-Pair-Id=APKAI7S6A5RYOXBWRPDA&Signature=kS~qXbRISE4mVJECJvN5DQVg7qzgT3g~Q1Z2Ol0g5xJ8rK1yfIeXBkGHkf3HB9KP-~dw-l68R~8m7hZEF8nNGlk9cDxBXlhGELBWM5fykJg5pSxz5eIE1F-aq3Wl5Mb2mHdNL7oDFW6TiKoEGVa1qb6z9lFhtGTDmfPZP8TjzQ0wDMHVJl1p09TJYXdPdZIWv1k5MjGM1vPtQvRDx7Cf-MX6s5E0SjRVhb2bWoLxfV8q9Y4ZgKjNp3uC7vT2Wm0A__"
    tar -xzf cellranger-9.0.0.tar.gz
    rm cellranger-9.0.0.tar.gz
    ln -s /opt/cellranger-9.0.0/bin/cellranger /usr/local/bin/cellranger

    # Make scripts executable
    chmod +x /opt/biopipelines/entrypoint.sh /opt/biopipelines/run_pipeline.sh
    
    # Create pipeline directory
    mkdir -p /opt/biopipelines/scrna_seq

    # Clean up
    micromamba clean --all --yes

%environment
    export PIPELINE_NAME="scrna-seq"
    export PIPELINE_VERSION="1.0.0"

%runscript
    exec /opt/biopipelines/entrypoint.sh "$@"

%test
    # Test scRNA-seq tools
    python -c "import scanpy; print('Scanpy:', scanpy.__version__)"
    python -c "import anndata; print('AnnData:', anndata.__version__)"
    Rscript -e "library(Seurat); cat('Seurat loaded\n')"
    echo "scRNA-seq container validation passed"
